<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - SAAD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="saad-body">
    <nav class="navbar saad-header navbar-expand-lg shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand saad-navbar-brand mb-0">
                <i class="fas fa-fingerprint me-2"></i>SAAD
            </span>
            
            <div class="d-flex align-items-center">
                <a href="dashboard.html" class="btn saad-header-btn me-2">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <button class="btn saad-header-btn me-2" onclick="alternarTema()">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="btn saad-header-btn btn-logout" onclick="sair()">
                    <i class="fas fa-sign-out-alt me-1"></i>Sair
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-5">
                    <div class="saad-logo mb-3 mx-auto">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <h2>Meu Perfil Acadêmico</h2>
                    <p class="text-muted">Gerencie suas informações pessoais</p>
                </div>

                <div class="saad-card p-4 mb-4">
                    <h4 class="mb-4"><i class="fas fa-info-circle me-2"></i>Dados Cadastrais</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label saad-label">Nome Completo</label>
                            <div class="saad-input" id="infoNome">Carregando...</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label saad-label">RA</label>
                            <div class="saad-input" id="infoRA">Carregando...</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label saad-label">Email</label>
                            <div class="saad-input" id="infoEmail">Carregando...</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label saad-label">Curso</label>
                            <div class="saad-input" id="infoCurso">Carregando...</div>
                        </div>
                    </div>
                </div>

                <div class="saad-card p-4">
                    <h4 class="mb-4"><i class="fas fa-chart-pie me-2"></i>Desempenho</h4>
                    
                    <div class="row text-center">
                        <div class="col-md-4 mb-3">
                            <div class="saad-stats-card p-3">
                                <div class="saad-stats-icon mx-auto mb-2" style="background: linear-gradient(135deg, #00b09b, #96c93d);">
                                    <i class="fas fa-check"></i>
                                </div>
                                <h4 class="mb-1" id="statPresencas">0</h4>
                                <small class="text-muted">Presenças</small>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="saad-stats-card p-3">
                                <div class="saad-stats-icon mx-auto mb-2" style="background: linear-gradient(135deg, #f7971e, #ffd200);">
                                    <i class="fas fa-exclamation text-dark"></i>
                                </div>
                                <h4 class="mb-1" id="statJustificadas">0</h4>
                                <small class="text-muted">Justificadas</small>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="saad-stats-card p-3">
                                <div class="saad-stats-icon mx-auto mb-2" style="background: linear-gradient(135deg, #ff416c, #ff4b2b);">
                                    <i class="fas fa-times"></i>
                                </div>
                                <h4 class="mb-1" id="statFaltas">0</h4>
                                <small class="text-muted">Faltas</small>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label saad-label mb-3">Frequência por Matéria</label>
                        <div id="graficoFrequencia"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase.js"></script>

    <script>
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function() {
            const tema = localStorage.getItem("tema") || "light";
            document.documentElement.setAttribute("data-theme", tema);
            
            auth.onAuthStateChanged(user => {
                if (!user) window.location.href = 'index.html';
                else {
                    currentUser = user;
                    carregarDados();
                }
            });
        });

        function carregarDados() {
            db.collection("users").where("Email", "==", currentUser.email).get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const data = snapshot.docs[0].data();
                        document.getElementById('infoNome').textContent = data.Nome;
                        document.getElementById('infoRA').textContent = data.RegistroAcademico;
                        document.getElementById('infoEmail').textContent = currentUser.email;
                        document.getElementById('infoCurso').textContent = data.Curso;
                        
                        return db.collection("presencas").where("RegistroAcademico", "==", data.RegistroAcademico).get();
                    }
                })
                .then(snapshot => {
                    if (snapshot) processarEstatisticas(snapshot);
                })
                .catch(err => console.error(err));
        }

        function processarEstatisticas(snapshot) {
            let presencas = 0, faltas = 0, just = 0;
            const materias = {};

            snapshot.forEach(doc => {
                const d = doc.data();
                const status = d.Status;
                const mat = d.Materia;

                // Contagem Geral
                if (status === 'Presente') presencas++;
                else if (status === 'Falta' || status === 'Ausente') faltas++;
                else just++;

                // Contagem por Matéria
                if (!materias[mat]) materias[mat] = { total: 0, p: 0 };
                materias[mat].total++;
                if (status === 'Presente') materias[mat].p++;
            });

            document.getElementById('statPresencas').textContent = presencas;
            document.getElementById('statFaltas').textContent = faltas;
            document.getElementById('statJustificadas').textContent = just;

            renderizarGraficos(materias);
        }

        function renderizarGraficos(materias) {
            const container = document.getElementById('graficoFrequencia');
            container.innerHTML = '';

            for (const [nome, dados] of Object.entries(materias)) {
                const pct = Math.round((dados.p / dados.total) * 100);
                
                // Cor dinâmica da barra: Verde (Bom), Amarelo (Médio), Vermelho (Ruim)
                let corBarra = 'linear-gradient(135deg, #00b09b, #96c93d)'; // Verde
                if (pct < 75) corBarra = 'linear-gradient(135deg, #f7971e, #ffd200)'; // Amarelo
                if (pct < 50) corBarra = 'linear-gradient(135deg, #ff416c, #ff4b2b)'; // Vermelho

                const html = `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small fw-bold">${nome}</span>
                            <span class="small">${pct}%</span>
                        </div>
                        <div class="progress" style="height: 8px; background-color: var(--saad-border);">
                            <div class="progress-bar" style="width: ${pct}%; background: ${corBarra};"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            }
        }

        function alternarTema() {
            const html = document.documentElement;
            const novo = html.getAttribute("data-theme") === "dark" ? "light" : "dark";
            html.setAttribute("data-theme", novo);
            localStorage.setItem("tema", novo);
        }

        function sair() {
            auth.signOut().then(() => window.location.href = 'index.html');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
