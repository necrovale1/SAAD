<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - SAAD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        (function() {
            const temaSalvo = localStorage.getItem("tema") || "light";
            document.documentElement.setAttribute("data-theme", temaSalvo);
        })();
    </script>
    <style>
        #relogioTopo {
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="saad-body">
    <nav class="navbar saad-header navbar-expand-lg shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand saad-navbar-brand mb-0"><i class="fas fa-fingerprint me-2"></i>SAAD</span>
            <div class="d-flex align-items-center">
                <div class="d-none d-md-flex align-items-center text-white me-4">
                    <i class="fas fa-clock me-2 opacity-75"></i>
                    <span id="relogioTopo">--:--:--</span>
                </div>
                <a href="dashboard.html" class="btn saad-header-btn me-2"><i class="fas fa-home me-1"></i>Dashboard</a>
                <button class="btn saad-header-btn me-2" onclick="alternarTema()"><i class="fas fa-moon"></i></button>
                <button class="btn saad-header-btn btn-logout" onclick="sair()"><i class="fas fa-sign-out-alt me-1"></i>Sair</button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-5">
                    <div class="saad-logo mb-3 mx-auto"><i class="fas fa-user-graduate"></i></div>
                    <h2>Meu Perfil Acadêmico</h2>
                    <p class="text-muted">Gerencie suas informações pessoais</p>
                </div>

                <div class="saad-card p-4 mb-4">
                    <h4 class="mb-4"><i class="fas fa-info-circle me-2"></i>Dados Cadastrais</h4>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label saad-label">Nome Completo</label><div class="saad-input" id="infoNome">Carregando...</div></div>
                        <div class="col-md-6"><label class="form-label saad-label">RA</label><div class="saad-input" id="infoRA">Carregando...</div></div>
                        <div class="col-md-6"><label class="form-label saad-label">Email</label><div class="saad-input" id="infoEmail">Carregando...</div></div>
                        <div class="col-md-6"><label class="form-label saad-label">Curso</label><div class="saad-input" id="infoCurso">Carregando...</div></div>
                    </div>
                </div>

                <div class="saad-card p-4">
                    <h4 class="mb-4"><i class="fas fa-chart-pie me-2"></i>Desempenho</h4>
                    <p class="text-muted small mb-4">Toque nos cartões para ver o histórico detalhado.</p>
                    <div class="row text-center">
                        <div class="col-md-4 mb-3">
                            <div class="saad-stats-card clickable-stat p-3" onclick="abrirModalEstatistica('Presente')">
                                <div class="saad-stats-icon mx-auto mb-2" style="background: linear-gradient(135deg, #00b09b, #96c93d);"><i class="fas fa-check"></i></div>
                                <h4 class="mb-1" id="statPresencas">0</h4><small class="text-muted">Presenças</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="saad-stats-card clickable-stat p-3" onclick="abrirModalEstatistica('Justificado')">
                                <div class="saad-stats-icon mx-auto mb-2" style="background: linear-gradient(135deg, #f7971e, #ffd200);"><i class="fas fa-clock text-white"></i></div>
                                <h4 class="mb-1" id="statJustificadas">0</h4><small class="text-muted">Justificadas</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="saad-stats-card clickable-stat p-3" onclick="abrirModalEstatistica('Falta')">
                                <div class="saad-stats-icon mx-auto mb-2" style="background: linear-gradient(135deg, #ff416c, #ff4b2b);"><i class="fas fa-times"></i></div>
                                <h4 class="mb-1" id="statFaltas">0</h4><small class="text-muted">Faltas</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="form-label saad-label mb-3">Frequência por Matéria</label>
                        <div id="graficoFrequencia">
                            <div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Calculando dados...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalStats" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content saad-card border-0">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title" id="modalStatsTitle">Detalhes</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="list-group list-group-flush" id="modalStatsList"></div>
                </div>
                <div class="modal-footer border-top border-secondary">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase.js"></script>

    <script>
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let dadosCache = [];

        document.addEventListener('DOMContentLoaded', function() {
            iniciarRelogio();
            auth.onAuthStateChanged(user => {
                if (!user) window.location.href = 'index.html';
                else {
                    currentUser = user;
                    carregarDados();
                }
            });
        });

        function iniciarRelogio() {
            const el = document.getElementById('relogioTopo');
            const update = () => el.textContent = new Date().toLocaleTimeString('pt-BR');
            update();
            setInterval(update, 1000);
        }

        function carregarDados() {
            db.collection("users").where("Email", "==", currentUser.email).get()
            .then(snapshot => {
                if (!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    document.getElementById('infoNome').textContent = data.Nome || 'Não informado';
                    document.getElementById('infoRA').textContent = data.RegistroAcademico || 'Não informado';
                    document.getElementById('infoEmail').textContent = currentUser.email;
                    document.getElementById('infoCurso').textContent = data.Curso || 'Não informado';
                    return db.collection("presencas").where("RegistroAcademico", "==", data.RegistroAcademico).orderBy('Data', 'desc').limit(100).get();
                }
            })
            .then(snapshot => { 
                dadosCache = [];
                if (snapshot && !snapshot.empty) {
                    snapshot.forEach(doc => dadosCache.push(doc.data()));
                }
                processarEstatisticas(); 
            })
            .catch(err => {
                console.error(err);
                document.getElementById('graficoFrequencia').innerHTML = '<div class="text-center text-muted">Erro ao carregar dados.</div>';
            });
        }

        function processarEstatisticas() {
            let p = 0, f = 0, j = 0;
            const materias = {};
            
            if (dadosCache.length === 0) {
                document.getElementById('graficoFrequencia').innerHTML = '<div class="text-center text-muted">Nenhum registro de aula encontrado.</div>';
                return;
            }

            dadosCache.forEach(d => {
                const status = (d.Status || "").toLowerCase().trim();
                if (status.includes('presente')) p++; 
                else if (status.includes('falta') || status.includes('ausente')) f++; 
                else j++;

                const matNome = d.Materia || "Outros";
                if (!materias[matNome]) materias[matNome] = { total: 0, p: 0 };
                materias[matNome].total++;
                if (status.includes('presente')) materias[matNome].p++;
            });

            document.getElementById('statPresencas').textContent = p;
            document.getElementById('statFaltas').textContent = f;
            document.getElementById('statJustificadas').textContent = j;
            renderizarGraficos(materias);
        }

        function renderizarGraficos(materias) {
            const container = document.getElementById('graficoFrequencia');
            container.innerHTML = '';

            for (const [nome, dados] of Object.entries(materias)) {
                const pct = dados.total > 0 ? Math.round((dados.p / dados.total) * 100) : 0;
                let displayWidth = pct <= 2 ? 5 : pct;
                let corBarra = 'linear-gradient(135deg, #00b09b, #96c93d)';
                if (pct < 75) corBarra = 'linear-gradient(135deg, #f7971e, #ffd200)';
                if (pct < 50) corBarra = 'linear-gradient(135deg, #ff416c, #ff4b2b)';

                const html = `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small fw-bold">${nome}</span>
                            <span class="small">${pct}%</span>
                        </div>
                        <div class="progress" style="height: 8px; background-color: var(--saad-border);">
                            <div class="progress-bar" style="width: ${displayWidth}%; background: ${corBarra}; transition: width 1s ease;"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            }
        }

        function abrirModalEstatistica(tipo) {
            const tituloMap = { 'Presente': 'Histórico de Presenças', 'Falta': 'Histórico de Faltas', 'Justificado': 'Justificativas/Atrasos' };
            document.getElementById('modalStatsTitle').textContent = tituloMap[tipo] || 'Detalhes';
            const listaEl = document.getElementById('modalStatsList');
            listaEl.innerHTML = '';

            const filtrados = dadosCache.filter(d => {
                const st = (d.Status || "").toLowerCase();
                if (tipo === 'Presente') return st.includes('presente');
                if (tipo === 'Falta') return st.includes('falta') || st.includes('ausente');
                return !st.includes('presente') && !st.includes('falta') && !st.includes('ausente');
            }).slice(0, 20);

            if (filtrados.length === 0) {
                listaEl.innerHTML = '<div class="p-4 text-center text-muted"><i class="fas fa-inbox fa-2x mb-2"></i><p class="mb-0">Nenhum registro deste tipo.</p></div>';
            } else {
                filtrados.forEach(d => {
                    let dataF = d.Data;
                    if(d.Data && d.Data.includes('-')) { const p = d.Data.split('-'); dataF = `${p[2]}/${p[1]}/${p[0]}`; }
                    
                    let badgeClass = 'bg-secondary';
                    if(tipo === 'Presente') badgeClass = 'bg-success';
                    if(tipo === 'Falta') badgeClass = 'bg-danger';
                    if(tipo === 'Justificado') badgeClass = 'bg-warning text-dark';

                    const item = document.createElement('div');
                    item.className = 'list-group-item bg-transparent border-secondary d-flex justify-content-between align-items-center px-4 py-3';
                    item.style.color = 'var(--saad-text)';
                    item.innerHTML = `<div><div class="fw-bold">${d.Materia}</div><small class="text-muted"><i class="fas fa-calendar-alt me-1"></i>${dataF}</small></div><span class="badge ${badgeClass} rounded-pill">${d.HoraEntrada || '--:--'}</span>`;
                    listaEl.appendChild(item);
                });
            }
            new bootstrap.Modal(document.getElementById('modalStats')).show();
        }

        function alternarTema() {
            const novo = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", novo);
            localStorage.setItem("tema", novo);
        }
        function sair() { auth.signOut().then(() => window.location.href = 'index.html'); }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
