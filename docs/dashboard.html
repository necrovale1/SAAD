<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SAAD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        (function() {
            const temaSalvo = localStorage.getItem("tema") || "light";
            document.documentElement.setAttribute("data-theme", temaSalvo);
        })();
    </script>
</head>
<body class="saad-body">
    <nav class="navbar saad-header navbar-expand-lg shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand saad-navbar-brand mb-0"><i class="fas fa-fingerprint me-2"></i>SAAD</span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3 d-none d-md-block"><i class="fas fa-user-circle me-1"></i><span id="studentName">Carregando...</span></span>
                <a href="perfil.html" class="btn saad-header-btn me-2" id="btnPerfil"><i class="fas fa-user me-1"></i>Perfil</a>
                <button class="btn saad-header-btn me-2" onclick="alternarTema()"><i class="fas fa-moon"></i></button>
                <button class="btn saad-header-btn btn-logout" onclick="sair()"><i class="fas fa-sign-out-alt me-1"></i>Sair</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4" id="mainContainer">
        <div class="text-center py-5">
            <i class="fas fa-circle-notch fa-spin fa-3x text-secondary"></i>
            <p class="mt-3 text-muted">Carregando painel...</p>
        </div>
    </div>

    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content saad-card border-0">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title" id="modalTitle">Detalhes</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="modalBody">
                    </div>
                <div class="modal-footer border-top border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase.js"></script>

    <script>
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function() {
            verificarAuth();
            iniciarRelogio();
        });

        function verificarAuth() {
            auth.onAuthStateChanged(user => {
                if (!user) window.location.href = 'index.html';
                else {
                    currentUser = user;
                    carregarPainelCorreto();
                }
            });
        }

        function carregarPainelCorreto() {
            db.collection("users").where("Email", "==", currentUser.email).get()
            .then(snap => {
                if(snap.empty) { alert("Erro: Usuário não encontrado."); return; }
                const data = snap.docs[0].data();
                document.getElementById('studentName').textContent = data.Nome || 'Usuário';
                
                if (data.Email === 'admin.ti@escola.com' || data.Cargo === 'Administrador de Sistemas') {
                    renderizarDashboardTI();
                } else if (data.UserType === 'Gestor') {
                    renderizarDashboardGestor();
                } else if (data.UserType === 'Professor') {
                    renderizarDashboardProfessor(data);
                } else {
                    renderizarDashboardAluno(data);
                }
            });
        }

        // ================== 1. GESTOR (Visão por Dia) ==================
        function renderizarDashboardGestor() {
            const html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div><h2 class="mb-1">Painel da Diretoria</h2><p class="text-muted mb-0">Frequência Geral da Escola</p></div>
                    <div class="text-end"><small class="fw-bold fs-5" id="relogio">--:--:--</small></div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3"><div class="saad-stats-card p-4 text-center"><h3>1.250</h3><small class="text-muted">Total Alunos</small></div></div>
                    <div class="col-md-3"><div class="saad-stats-card p-4 text-center"><h3 id="mediaGeral">--%</h3><small class="text-muted">Média Geral</small></div></div>
                    <div class="col-md-3"><div class="saad-stats-card p-4 text-center"><h3>45</h3><small class="text-muted">Professores</small></div></div>
                    <div class="col-md-3"><div class="saad-stats-card p-4 text-center text-danger"><h3>5</h3><small class="text-muted">Turmas Críticas</small></div></div>
                </div>

                <div class="saad-card p-4">
                    <h5 class="mb-3">Histórico de Frequência (Por Dia)</h5>
                    <p class="text-muted small mb-3">Clique na data para ver detalhes por matéria e professor.</p>
                    <div class="table-responsive">
                        <table class="table saad-table table-hover align-middle">
                            <thead><tr><th>Data</th><th>Total Aulas</th><th>Presença Média</th><th>Status</th><th>Ação</th></tr></thead>
                            <tbody id="tabelaGestorDias"><tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Calculando...</td></tr></tbody>
                        </table>
                    </div>
                </div>`;
            document.getElementById('mainContainer').innerHTML = html;

            db.collection("presencas").orderBy("Data", "desc").limit(500).get().then(snap => {
                const diasMap = {};
                let totalGeralP = 0, totalGeralT = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    if (!diasMap[d.Data]) diasMap[d.Data] = { data: d.Data, total: 0, p: 0, registros: [] };
                    
                    diasMap[d.Data].total++;
                    if ((d.Status || "").toLowerCase().includes('presente')) {
                        diasMap[d.Data].p++;
                        totalGeralP++;
                    }
                    totalGeralT++;
                    diasMap[d.Data].registros.push(d);
                });

                document.getElementById('mediaGeral').textContent = totalGeralT > 0 ? `${Math.round((totalGeralP/totalGeralT)*100)}%` : '0%';
                const tbody = document.getElementById('tabelaGestorDias');
                tbody.innerHTML = '';

                Object.values(diasMap).sort((a,b) => a.data < b.data ? 1 : -1).forEach(dia => {
                    const pct = Math.round((dia.p / dia.total) * 100);
                    let badge = pct < 70 ? '<span class="badge bg-danger">Crítico</span>' : (pct < 85 ? '<span class="badge bg-warning text-dark">Atenção</span>' : '<span class="badge bg-success">Bom</span>');
                    const safeData = dia.data.replace(/[^0-9]/g, '');
                    window[`dia_${safeData}`] = dia.registros;

                    tbody.innerHTML += `
                        <tr class="clickable-row" onclick="abrirDetalhesDiaGestor('${dia.data}', '${safeData}')">
                            <td><i class="fas fa-calendar-day me-2 text-primary"></i>${formatarData(dia.data)}</td>
                            <td>${dia.total} aulas</td>
                            <td><div class="d-flex align-items-center"><span class="me-2 fw-bold">${pct}%</span><div class="progress flex-grow-1" style="height: 6px; width: 80px;"><div class="progress-bar ${pct < 70 ? 'bg-danger' : 'bg-success'}" style="width: ${pct}%"></div></div></div></td>
                            <td>${badge}</td>
                            <td><button class="btn btn-sm btn-outline-secondary"><i class="fas fa-eye"></i> Ver</button></td>
                        </tr>`;
                });
            });
        }

        function abrirDetalhesDiaGestor(dataString, idDados) {
            const registros = window[`dia_${idDados}`] || [];
            document.getElementById('modalTitle').textContent = `Detalhes do Dia: ${formatarData(dataString)}`;
            
            const turmasMap = {};
            registros.forEach(reg => {
                const mat = reg.Materia || "Geral";
                if (!turmasMap[mat]) turmasMap[mat] = { nome: mat, total: 0, p: 0 };
                turmasMap[mat].total++;
                if ((reg.Status||"").toLowerCase().includes('presente')) turmasMap[mat].p++;
            });

            let html = `<div class="table-responsive"><table class="table table-sm align-middle mb-0"><thead class="table-light"><tr><th>Matéria</th><th>Professor (Responsável)</th><th>Presença</th><th>Status</th></tr></thead><tbody>`;
            
            Object.values(turmasMap).forEach(t => {
                const pct = Math.round((t.p / t.total) * 100);
                html += `<tr><td><strong>${t.nome}</strong></td><td>Prof. ${t.nome.split(' ')[0]}</td><td>${pct}% (${t.p}/${t.total})</td><td>${pct < 75 ? '<span class="text-danger">Baixa</span>' : '<span class="text-success">Normal</span>'}</td></tr>`;
            });
            html += '</tbody></table></div>';
            
            document.getElementById('modalBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
        }

        // ================== 2. PROFESSOR (Visão por Matéria) ==================
        function renderizarDashboardProfessor() {
            const html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div><h2 class="mb-1">Minhas Turmas</h2><p class="text-muted mb-0">Frequência por Matéria</p></div>
                    <div class="text-end"><small class="fw-bold fs-5" id="relogio">--:--:--</small></div>
                </div>
                <div class="saad-card p-4"><div class="table-responsive"><table class="table saad-table table-hover align-middle"><thead><tr><th>Matéria</th><th>Presença Hoje</th><th>Última Aula</th><th>Ação</th></tr></thead><tbody id="tabelaProf"><tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i></td></tr></tbody></table></div></div>`;
            document.getElementById('mainContainer').innerHTML = html;

            db.collection("presencas").orderBy("Data", "desc").limit(100).get().then(snap => {
                const materiasMap = {};
                const hoje = new Date().toISOString().split('T')[0];

                snap.forEach(doc => {
                    const d = doc.data();
                    if (!materiasMap[d.Materia]) materiasMap[d.Materia] = { nome: d.Materia, totalHoje: 0, ultimaData: d.Data, alunos: [] };
                    materiasMap[d.Materia].alunos.push(d);
                    if(d.Data === hoje && (d.Status||"").includes('Presente')) materiasMap[d.Materia].totalHoje++;
                });

                const tbody = document.getElementById('tabelaProf');
                tbody.innerHTML = '';
                
                Object.values(materiasMap).forEach(mat => {
                    const safeMateria = mat.nome.replace(/[^a-zA-Z0-9]/g, '_');
                    window[`dados_${safeMateria}`] = mat.alunos;
                    tbody.innerHTML += `<tr><td><span class="fw-bold text-primary">${mat.nome}</span></td><td><span class="badge bg-success rounded-pill">${mat.totalHoje} presentes</span></td><td>${formatarData(mat.ultimaData)}</td><td><button class="btn btn-sm btn-outline-primary" onclick="abrirModalTurma('${mat.nome}', '${safeMateria}')"><i class="fas fa-users me-1"></i> Chamada</button></td></tr>`;
                });
            });
        }

        function abrirModalTurma(nome, id) {
            const alunos = window[`dados_${id}`] || [];
            document.getElementById('modalTitle').textContent = `Frequência: ${nome}`;
            let html = `<div class="table-responsive"><table class="table table-sm align-middle mb-0"><thead class="table-light"><tr><th>RA Aluno</th><th>Data</th><th>Entrada/Saída</th><th>Status</th></tr></thead><tbody>`;
            alunos.slice(0, 20).forEach(a => {
                html += `<tr><td class="fw-bold">${a.RegistroAcademico}</td><td>${formatarData(a.Data)}</td><td>${a.HoraEntrada} - ${a.HoraSaida}</td><td>${getStatusBadge(a.Status)}</td></tr>`;
            });
            html += '</tbody></table></div>';
            document.getElementById('modalBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
        }

        // ================== 3. ADMIN TI ==================
        function renderizarDashboardTI() {
            document.getElementById('mainContainer').innerHTML = `<div class="alert alert-dark mb-4"><i class="fas fa-terminal me-2"></i>Painel TI</div><div class="row"><div class="col-lg-12"><div class="saad-card p-4"><h5>Logs do Sistema</h5><div class="p-3 bg-dark text-success font-monospace small"><div>[SYSTEM] Database connected.</div><div>[AUTH] User login success.</div></div></div></div></div>`;
        }

        // ================== 4. ALUNO ==================
        function renderizarDashboardAluno(userData) {
            const html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div><h2 class="mb-1">Minhas Aulas</h2><p class="text-muted mb-0">Olá, ${userData.Nome.split(' ')[0]}</p></div>
                    <div class="text-end"><small class="fw-bold fs-5" id="relogio">--:--:--</small></div>
                </div>
                <div class="row"><div class="col-lg-12"><div class="saad-card p-4"><div class="table-responsive"><table class="table saad-table"><thead><tr><th>Data</th><th>Matéria</th><th>Status</th></tr></thead><tbody id="tabelaAluno"></tbody></table></div></div></div></div>`;
            document.getElementById('mainContainer').innerHTML = html;

            db.collection("presencas").where("RegistroAcademico", "==", userData.RegistroAcademico).orderBy("Data", "desc").limit(20).get()
            .then(snap => {
                const tbody = document.getElementById('tabelaAluno');
                snap.forEach(doc => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr><td>${formatarData(d.Data)}</td><td>${d.Materia}</td><td>${getStatusBadge(d.Status)}</td></tr>`;
                });
            });
        }

        // UTILS
        function iniciarRelogio() {
            const el = document.getElementById('relogio');
            if(el) setInterval(() => el.textContent = new Date().toLocaleTimeString('pt-BR'), 1000);
        }
        function formatarData(s) { if(!s) return '--'; if(s.includes('-')) { const p = s.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; } return s; }
        function getStatusBadge(s) { let c='bg-secondary'; s=(s||"").toLowerCase(); if(s.includes('presente')) c='saad-badge-presente'; else if(s.includes('falta')) c='saad-badge-falta'; return `<span class="badge ${c}">${s}</span>`; }
        function alternarTema() {
            const novo = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", novo);
            localStorage.setItem("tema", novo);
        }
        function sair() { auth.signOut().then(() => window.location.href = 'index.html'); }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
